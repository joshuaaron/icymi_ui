<div class="context-menu-wrapper">
  <div class="playing">
    <div class="playing__meta">
      <div class="details">
        <div>Into the Jungle</div>
        <div>Audiobook</div>
      </div>
      <div class="actions">
        <button popovertarget="context" id="anchor">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
            class="w-6 h-6"
          >
            <path
              stroke-linecap="round"
              fill="none"
              stroke-width="2"
              stroke-linejoin="round"
              d="M4.5 15.75l7.5-7.5 7.5 7.5"
            />
          </svg>
          <span class="sr-only">Toggle menu</span>
        </button>
        <nav popover="auto" id="context">
          <ul>
            <li>Add to queue</li>
            <hr>
            <li>Go to song radio</li>
            <li>Go to artist</li>
            <li>Go to album</li>
            <hr>
            <li>Save to your library</li>
            <li>
              <button popovertarget="playlist" id="playlist-anchor">
                <span>Add to playlist</span>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                  class="w-6 h-6"
                >
                  <path
                    stroke-linecap="round"
                    fill="none"
                    stroke-width="2"
                    stroke-linejoin="round"
                    d="M4.5 15.75l7.5-7.5 7.5 7.5"
                  />
                </svg>
              </button>
            </li>
            <hr>
            <li>
              <button popovertarget="share" id="share-anchor">
                <span>Share</span>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                  class="w-6 h-6"
                >
                  <path
                    stroke-linecap="round"
                    fill="none"
                    stroke-width="2"
                    stroke-linejoin="round"
                    d="M4.5 15.75l7.5-7.5 7.5 7.5"
                  />
                </svg>
              </button>
            </li>
          </ul>
        </nav>
        <div popover="auto" id="share">
          <ul>
            <li>
              <a
                href="https://twitter.com/intent/follow?screen_name=jh3yy"
                target="_blank"
                rel="noopener noreferrer"
                >Share on X</a
              >
            </li>
            <li>Copy Song Link</li>
            <li>Embed track</li>
          </ul>
        </div>
        <div popover="auto" id="playlist">
          <ul>
            <li>
              <input type="search" placeholder="Find a playlist">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="1.5"
                stroke="currentColor"
                class="w-6 h-6"
              >
                <path
                  stroke-linecap="round"
                  fill="none"
                  stroke="var(--text-1)"
                  stroke-linejoin="round"
                  d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"
                />
              </svg>
            </li>
            <li>Create playlist</li>
            <hr>
            <li>Lofi</li>
            <li>Chill</li>
            <li>Liked</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .context-menu-wrapper {
    height: 80svh;
  }

  @layer foundation {
    :root {
      --alpha: 0.15;
      --backdrop: white;
      --line: color-mix(in lch, canvasText 25%, transparent);
      --shadow:
        0 0 0 1px rgba(0, 0, 0, 0.08), 0px 1px 1px rgba(0, 0, 0, 0.02),
        0px 4px 8px -4px rgba(0, 0, 0, 0.04),
        0px 16px 24px -8px rgba(0, 0, 0, 0.06);
    }

    hr {
      margin-block: 0;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }

    [popovertarget] svg {
      transition:
        rotate 0.2s,
        transform 0.2s;
    }

    [popover] {
      margin: 0;
      inset: unset;
      border: 0;
      padding: 4px;
      border-radius: 6px;
      box-shadow: var(--shadow);
      background: var(--backdrop);
    }

    button {
      width: 40px;
      aspect-ratio: 1;
      border-radius: 6px;
      border: 0;
      background: transparent;
      cursor: pointer;
      position: relative;
    }

    li,
    a {
      position: relative;
    }

    :is(button, li, a)::after {
      content: "";
      position: absolute;
      inset: 0;
      background: hsl(0 0% 50% / var(--alpha));
      opacity: var(--intent, 0);
      transition: opacity 0.2s;
      border-radius: 6px;
      pointer-events: none;
    }

    :is(button, li:not(:has(button, a)), a):is(:hover, :focus-visible) {
      --intent: 1;
    }

    li {
      white-space: nowrap;
      height: 40px;
      display: flex;
      align-items: center;
      padding: 0 0.5rem;
    }

    li:has(button, a) {
      padding: 0;
    }

    [popover] a {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      padding: 0 0.5rem;
      text-decoration: none;
      color: currentColor;
    }

    [type="search"] {
      height: 100%;
      text-align: left;
      padding: 0;
      border: 0;
      background: transparent;
      inline-size: 140px;
    }

    [type="search"] + svg {
      opacity: 0.5;
    }

    [popover] button {
      width: 100%;
      height: 100%;
      aspect-ratio: auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 0.5rem;
    }

    [popover] {
      --speed: 0.3s;
      opacity: 0;
      scale: 0.9;
      filter: blur(10px);
      transition:
        display var(--speed) allow-discrete,
        overlay var(--speed) allow-discrete,
        opacity var(--speed),
        scale var(--speed),
        filter var(--speed);
    }
    [popover]:popover-open {
      opacity: 1;
      scale: 1;
      filter: blur(0px);
    }
    @starting-style {
      [popover]:popover-open {
        opacity: 0;
        scale: 0.9;
        filter: blur(10px);
      }
    }
  }

  @layer cover {
    .playing {
      width: 200px;
      font-size: 14px;
      border-radius: 6px;
      display: grid;
      box-shadow: var(--shadow);

      span {
        color: var(--shade-dark);
      }
    }
    .playing img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      aspect-ratio: 1;
    }
    .details {
      display: grid;
      font-weight: 600;
      color: var(--shade-dark);
    }
    .details div:last-of-type {
      font-size: 12px;
      font-weight: 200;
    }
    .playing__meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.25rem calc(4px + 0.5rem);
      padding-right: 0.25rem;
      background: var(--backdrop);
      border-radius: 6px;
      min-height: 40px;
    }
    .playing__meta svg {
      width: 20px;
      rotate: 90deg;
    }
  }

  :root:has(#context:popover-open) [popovertarget="context"] svg {
    rotate: 270deg;
  }
  :root:has(#share:popover-open) [popovertarget="share"] svg,
  :root:has(#playlist:popover-open) [popovertarget="playlist"] svg {
    rotate: 270deg;
  }

  @supports (anchor-name: --anchor) {
    [popovertarget="context"] {
      anchor-name: --anchor;
    }
    #context {
      position-anchor: --anchor;
    }

    [popovertarget="share"] {
      anchor-name: --share;
    }
    #share {
      position-anchor: --share;
    }

    [popovertarget="playlist"] {
      anchor-name: --playlist;
    }
    #playlist {
      position-anchor: --playlist;
    }

    [popover] {
      inset: unset;
      margin-inline: 8px;
      position-area: inline-end span-block-end;
      position-try-fallbacks: --custom-flip-block-end, --custom-flip-block-start;
    }

    @position-try --custom-flip-block-end {
      position-area: block-end span-inline-start;
      margin-block-start: 12px;
      margin-inline: 0;
    }
    @position-try --custom-flip-block-start {
      position-area: block-start span-inline-start;
      margin-block-end: 8px;
      margin-inline: 0;
    }
  }
</style>

<script>
  import { gsap } from "gsap";
  import { Draggable } from "gsap/all";

  gsap.registerPlugin(Draggable);
  const anchor = document.querySelector(".playing");
  Draggable.create(anchor, {
    type: "x,y",
    bounds: ".context-menu-wrapper",
  });
</script>
